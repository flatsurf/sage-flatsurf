name: Test
on:
  push: { branches: [ "master" ] }
  pull_request: { branches: [ "master" ] }

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: "${{ matrix.on }}"
    strategy:
      matrix:
        include:
        - on: ubuntu-24.04
          environment: sagemath-94
        - on: ubuntu-24.04
          environment: sagemath-95
        - on: ubuntu-24.04
          environment: sagemath-96
        - on: ubuntu-24.04
          environment: sagemath-97
        - on: ubuntu-24.04
          environment: sagemath-98
        - on: ubuntu-24.04
          environment: sagemath-100
        - on: ubuntu-24.04
          environment: sagemath-101
        - on: ubuntu-24.04
          environment: sagemath-102
        - on: ubuntu-24.04
          environment: dev
        - on: macos-13
          environment: dev
    steps:
    - uses: actions/checkout@v2
      with: { submodules: recursive }
    - uses: prefix-dev/setup-pixi@v0.8.1
      with:
        pixi-version: v0.28.2
        environments: ${{ matrix.environment }}
    - name: Run doctests
      run: pixi run -e ${{ matrix.environment }} doctest-long
    - name: Run pytest tests
      run: pixi run -e ${{ matrix.environment }} pytest
      if: ${{ matrix.environment == 'dev' }}

env:
  MAKEFLAGS: -j4
  SAGE_NUM_THREADS: 4
